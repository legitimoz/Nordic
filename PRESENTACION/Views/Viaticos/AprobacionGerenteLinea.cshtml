
@{
    ViewBag.Title = "AprobacionGerenteLinea";
    Layout = "~/Views/Layout/_LayoutViatico.cshtml";
}



<main>
    <div class="container">
        <h3 class="text-center">Modulo de Aprobaciones Viaticos</h3>
        <div class="row   text-white" style="background-color: #e9ecef; ">

            <div class="col-sm-3 col-6">
                <div class="input-group mb-1">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon3">Fecha Inicio</span>
                    </div>
                    <input type="date" class="form-control" id="lc_dt_fec_ini" aria-describedby="basic-addon3">
                </div>
            </div>
            <div class="col-sm-3 col-6">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon3">Fecha Fin</span>
                    </div>
                    <input type="date" class="form-control" id="lc_dt_fec_fin" aria-describedby="basic-addon3">
                </div>
            </div>


            <div class="col-sm-3 col-6">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="inputGroupSelect01">Estados</label>
                    </div>
                    <select class="custom-select" id="est_via_apro">
                        <option selected>Elija...</option>

                    </select>
                </div>
            </div>

            <div class="col-sm-3 col-6">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <!--input class="form-control" type="search" placeholder="Buscar" aria-label="Search"-->
                        <!-- prueba-->
                        <!--- FIN DE PRUEBA-->
                    </div>

                </div>
            </div>

        </div>

        <div class="row  mb-1 p-2 text-white" style="background-color: #e9ecef; ">

           
                <div class="col-sm-4 col-6">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="via_repre_lst">Representantes</label>
                        <select class="custom-select" id="via_repre_lst">
                            <option value="0" selected>Elija...</option>

                        </select>
                    
                    </div>
                    


                </div>

                <div class="col-sm-3 col-3">
                    <!--BOTON BUSCAR POR FECHA-->
                    <button type="button" id="via_apro_btn_search"  onclick="LimpiarBusqueda()" class="btn btn-dark"><i class="bi bi-search"></i>Limpiar Busqueda</button>
                </div>

            </div>

            <h4></h4>

         <div class="row">

                <div class="table-responsive table-responsive-md table-responsive-lg">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th scope="col">#Solicitud</th>
                                <th scope="col">Representante</th>
                                <th scope="col">Estado</th>
                                <th scope="col">Linea</th>
                                <th scope="col">Fecha Solicitud</th>
                                <th scope="col">Motivo Viaje</th>
                                <th scope="col">Monto Solicitado</th>
                                <th scope="col">Medio Viaje</th>
                                <th scope="col">Origen</th>
                                <th scope="col">Destino</th>
                                <th scope="col">VerDetalle</th>
                                <th scope="col">Aprobar</th>
                                <th scope="col">Desaprobar</th>
                            </tr>
                        </thead>
                        <tbody id="tabla_cabecera_viaticos">
                        </tbody>
                    </table>
                </div>
            </div>



            <!-- MODAL VIATICO CREADA DETALLE-->
            <div class="modal fade" id="exampleModalCenter_viatico" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Editar Cotizacion</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!--Cotizacion a Modificar--->
                            <main role="main">
                                <div class="jumbotron">

                                    <div class="container">
                                        <h4>Numero Solicitud</h4>
                                        <input disabled type="text" style="font-size:14px;" id="via_num_sol" value="" />
                                        <div class="row">

                                            <ul class="nav nav-tabs" id="myTab" role="tablist">
                                                <li class="nav-item" role="presentation">
                                                    <a class="nav-link  col-12 col-sm-12" id="home-tab" data-toggle="tab" href="#solicitud" role="tab" aria-controls="home" aria-selected="false">Cabecera Solicitud</a>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <a class="nav-link active col-12 col-sm-12" id="profile-tab" data-toggle="tab" href="#clientes" role="tab" aria-controls="profile" aria-selected="true">Detalle Clientes</a>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <a class="nav-link col-12 col-sm-12" id="gastos-tab" data-toggle="tab" href="#gastos" role="tab" aria-controls="gastos" aria-selected="false">Detalle Gastos</a>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="tab-content" id="myTabContent">

                                            <div class="tab-pane fade" id="solicitud" role="tabpanel" aria-labelledby="home-tab">

                                                <div class="container">
                                                    <div class="p-2"></div>
                                                    <div class="row">


                                                        <div class="col-md-12 order-md-1">
                                                            <h4 class="mb-3"></h4>
                                                            <form class="needs-validation" novalidate>
                                                                <div class="row">
                                                                    <div class="col-md-8 mb-3">
                                                                        <label for="firstName">Nombre</label>
                                                                        <input type="text" class="form-control" id="v_r_nombre" placeholder="" value="" required>
                                                                        <div class="invalid-feedback">
                                                                            Nombre es requerido
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-4 mb-3">
                                                                        <label for="country">Linea</label>
                                                                        @*<input disabled class="form-control" value="@ViewBag.ViaCabSol.Nombrelinea" required>*@

                                                                        <div class="invalid-feedback">
                                                                            Linea Requerida
                                                                        </div>
                                                                    </div>

                                                                </div>

                                                                <div class="row">
                                                                    <div class="col-md-4 mb-3">
                                                                        <label for="country">Fecha Solicitud</label>
                                                                        @*<input type="date" class="form-control" id="via_fecha_solicitud" placeholder="" value="@ViewBag.ViaCabSol." required>*@
                                                                        <div class="invalid-feedback">
                                                                            Fecha Solicitud requerida
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-4 mb-3">
                                                                        <label for="state">Motivo Viaje</label>
                                                                        @*<input class="custom-select d-block w-100" value="@ViewBag.ViaCabSol.NombreMotivoViaje" required>*@

                                                                        <div class="invalid-feedback">
                                                                            Motivo viaje requerido
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-2 mb-3">
                                                                        <label for="zip">Monto Solicitado</label>
                                                                        <input type="number" class="form-control" id="via_monto_sol" placeholder="" required>
                                                                        <div class="invalid-feedback">
                                                                            Monto Solicitud requerido
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="row">
                                                                    <div class="col-md-4 mb-3">
                                                                        <label for="username">Medio de Viaje</label>
                                                                        <div class="input-group">

                                                                            @*<input class="custom-select d-block w-100" value="@ViewBag.ViaCabSol.NombreMedioViaje" required>*@

                                                                            <div class="invalid-feedback" style="width: 100%;">
                                                                                Medio de Viaje Requerido
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>


                                                                <hr class="mb-4">
                                                                <h6>Origen</h6>

                                                                <div class="row">

                                                                    <div class="col-md-3 mb-3">
                                                                        <label for="country">Fecha Y hora Origen</label>
                                                                        @*<input type="datetime-local" class="form-control" placeholder="" value="@ViewBag.ViaCabSol.fecha_origi" required>*@
                                                                        <div class="invalid-feedback">
                                                                            Fecha y Hora requerido
                                                                        </div>
                                                                    </div>

                                                                    <div class="col-md-3 mb-3">
                                                                        <label for="country">Departamento</label>
                                                                        @*<input class="custom-select d-block w-100" value="@ViewBag.ViaCabSol.id_depart_ori" required>*@


                                                                        <div class="invalid-feedback">
                                                                            Departamento requerido.
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3 mb-3">
                                                                        <label for="state">Provincia</label>
                                                                        @*<input class="custom-select d-block w-100" value="@ViewBag.ViaCabSol.id_prov_ori" required>*@

                                                                        <div class="invalid-feedback">
                                                                            Provincia requerida
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3 mb-3">
                                                                        <label for="zip">Distrito</label>
                                                                        @*<input class="custom-select d-block w-100" value="@ViewBag.ViaCabSol.id_distri_ori" required>*@


                                                                        <div class="invalid-feedback">
                                                                            Distrito  requerido.
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <h6>Destino</h6>
                                                                <div class="row">
                                                                    <div class="col-md-3 mb-3">
                                                                        <label for="country">Fecha Y hora Destino</label>
                                                                        <input type="datetime-local" class="form-control" id="via_fec_hora_dest" placeholder="" value="" required>
                                                                        <div class="invalid-feedback">
                                                                            Fecha y Hora requerido
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3 mb-3">
                                                                        <label for="country">Departamento</label>
                                                                        @*<input class="custom-select d-block w-100" value="@ViewBag.ViaCabSol.id_depart_dest" required>*@


                                                                        <div class="invalid-feedback">
                                                                            Departamento requerio
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3 mb-3">
                                                                        <label for="state">Provincia</label>
                                                                        @*<input class="custom-select d-block w-100" value="@ViewBag.ViaCabSol.id_prov_dest" required>*@

                                                                        <div class="invalid-feedback">
                                                                            Provincia requerida
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3 mb-3">
                                                                        <label for="zip">Distrito</label>
                                                                        @*<input class="custom-select d-block w-100" value="@ViewBag.ViaCabSol.id_distri_dest" required>*@

                                                                        <div class="invalid-feedback">
                                                                            Distrito requerido
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <hr class="mb-4">

                                                                <div class="row">
                                                                    <div class="col-md-3 mb-3">
                                                                        <label for="cc-expiration">Fecha Termino Viaje</label>
                                                                        <input type="date" class="form-control" id="via_fec_term_viaje" placeholder="" required>
                                                                        <div class="invalid-feedback">
                                                                            Fecha termino requerida
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-3 mb-3">
                                                                        <label for="cc-cvv">Monto Proyectado</label>
                                                                        <input type="text" class="form-control" id="via_mont_esperado" placeholder="" required>
                                                                        <div class="invalid-feedback">
                                                                            Monto Esperado requerido
                                                                        </div>
                                                                    </div>

                                                                    <div class="col-md-3 mb-3">
                                                                        <label for="cc-cvv">Cantidad Dias</label>
                                                                        <input type="text" class="form-control" id="via_cant_dias" placeholder="" required>
                                                                        <div class="invalid-feedback">
                                                                            Dias  requerido
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <hr class="mb-4">
                                                                @*<button class="btn btn-primary btn-lg btn-block" id="btn_reg_via">Registrar Solicitud</button>*@
                                                            </form>
                                                        </div>
                                                    </div>

                                                    <footer class="my-5 pt-5 text-muted text-center text-small">
                                                        <p class="mb-1">&copy; 2021-2023 FGB</p>
                                                        <ul class="list-inline">
                                                        </ul>
                                                    </footer>
                                                </div>

                                            </div>

                                            <div class="tab-pane fade show active" id="clientes" role="tabpanel" aria-labelledby="profile-tab">

                                                <!--Registro Clientes-->
                                                <h4 class="mb-3"></h4>

                                                <div class="form-row">

                                                    <div class="col-md-5 mb-5">
                                                        <label for="via_clie_select" class="col-2 col-sm-1 col-form-label">Cliente </label>
                                                        <select id="via_clie_select" data-placeholder="Choose one thing" class="form-control col-md-12 mb-12">
                                                        </select>
                                                    </div>

                                                    <div class="col-md-2 mb-3">
                                                        <label for="via_mont_esperado_clie">Monto Proyectado</label>
                                                        <input type="text" class="form-control" style="height:29px;" id="via_mont_esperado_clie" required>
                                                        <div class="invalid-feedback">
                                                            Monto Esperado requerido
                                                        </div>
                                                    </div>

                                                    <div class="col-md-3 mb-3">
                                                        <label for="via_det_add_clie"> Registrar </label>
                                                        <button class="form-control btn btn-primary" style="height:29px;" id="via_det_add_clie" onclick="RegistrarCliente();"> Registrar Cliente </button>
                                                    </div>
                                                </div>


                                                <div class="table-responsive">


                                                    <table id="mytable" class="table table-sm table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th scope="col">RUC</th>
                                                                <th scope="col">RAZON SOCIAL</th>
                                                                <th scope="col">MONTO</th>
                                                                <th scope="col">ANULAR</th>

                                                            </tr>
                                                        </thead>

                                                        <tbody id="via_detalle_clientes">
                                                        </tbody>

                                                    </table>

                                                </div>

                                                <!---->

                                                <div class="col-md-12  ">



                                                </div>
                                            </div>


                                            <div class="tab-pane fade" id="gastos" role="tabpanel" aria-labelledby="gastos-tab">
                                                <h4 class="mb-3"></h4>

                                                <!--FORM DE REGISTRO DE VIATICOS-->


                                                <div class="form-row">
                                                    <div class="col-md-4 mb-4">
                                                        <label for="list_gastos_presupuesto">Conceptos Gastos</label>
                                                        <select class="custom-select" id="list_gastos_presupuesto" required>
                                                            <option selected disabled value="">Elija...</option>

                                                        </select>
                                                    </div>

                                                    <div class="col-md-1 mb-1">
                                                        <label for="validationDefault03">Cantidad</label>
                                                        <input type="text" style="height:29px;" class="form-control" id="validationDefault03" required>
                                                    </div>

                                                    <div class="col-md-1 mb-1">
                                                        <label for="validationDefault05">Precio</label>
                                                        <input type="text" style="height:29px;" class="form-control" id="validationDefault05" required>
                                                    </div>

                                                    <div class="col-md-2 mb-2">
                                                        <label for="validationDefault06"> Registrar</label>
                                                        <button class="form-control btn btn-primary" style="height:29px;" id="validationDefault06" type="submit">Registrar</button>
                                                    </div>
                                                </div>



                                                <!--FIN DE FORM -->


                                                <div class="table-responsive">


                                                    <table id="mytable" class="table table-sm table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th scope="col">#</th>
                                                                <th scope="col">Concepto de Gasto</th>
                                                                <th scope="col">Cantidad</th>
                                                                <th scope="col">Precio</th>
                                                                <th scope="col">Confirmar</th>
                                                                <th scope="col">Anular</th>
                                                                <th scope="col">Editar</th>

                                                            </tr>
                                                        </thead>

                                                        <tbody id="via_dt_concepto_presupuesto">
                                                        </tbody>

                                                    </table>
                                                    @*<button class="btn btn-primary btn-lg btn-block" id="btn_reg_via">Registrar Detalle</button>*@
                                                </div>
                                            </div>

                                        </div>





                                    </div>

                                </div>



                            </main>
                            <!--FIN --->



                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary">Save changes</button>
                        </div>
                    </div>
                </div>
            </div>
            <!--FIN MODAL EDITAR-->
            <!--MODAL ADJUNTO-->
            <!-- MODAL VIATICO CREADA DETALLE-->
            <div class="modal fade" id="exampleModalCenter_VIA_GASTO" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Editar Cotizacion</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!--Cotizacion a Modificar--->
                            <main role="main">
                                <div class="jumbotron">

                                    <div class="container">
                                        <h4>Numero Solicitud</h4>
                                        <input disabled type="text" style="font-size:8px;" id="via_num_sol" value="" />



                                        <div class="row">
                                            <div class="col-6">

                                                <label for="cc-expiration">Dias</label>
                                                <input type="text" class="form-control" id="dias_gasto_modificar" onkeyup="capturadatos()" placeholder="" value="" required>
                                                <div class="invalid-feedback">
                                                    Dias requerida
                                                </div>

                                                <label for="cc-expiration">Precio</label>
                                                <input type="text" class="form-control" id="precio_gasto_modificar" onkeyup="capturadatos_2()" placeholder="" value="" required>
                                                <div class="invalid-feedback">
                                                    Precio requerido
                                                </div>





                                            </div>


                                        </div>
                                    </div>

                                </div>



                            </main>
                            <!--FIN --->



                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                            <button type="button" id="via-gastos-mod-btn" class="btn btn-primary">Guardar Cambios</button>
                        </div>
                    </div>
                </div>
            </div>
            <!--FIN MODAL EDITAR-->
            <!--MODAL ADJUNTO-->


        </div>
</main>

<script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
<script src="~/Assets/dist/js/bootstrap.bundle.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" type="text/javascript"></script>


<script type="text/javascript">
    $(document).ready(function () {

        init();
    });

    function init() {

        $("#via_repre_lst").select2({
           // minimumInputLength: 3 // para buscar a partir del 3er digito
        });

        ListadoViaticos("EA",0);
        $("#via_clie_select").select2({
            minimumInputLength: 3 // para buscar a partir del 3er digito
        });



        $("#est_via_apro").on('change', function () {
            var cod_estado = document.getElementById('est_via_apro').value;
            ListadoViaticos(cod_estado,0);
            // console.log("cambio estados " + idestado);
        });

        $("#via_repre_lst").on('change', function () {
            var cod_estado = document.getElementById('est_via_apro').value;
            var COD_REPRE = document.getElementById('via_repre_lst').value;
           // alert(cod_estado +"-"+COD_REPRE);
            ListadoViaticos(cod_estado, COD_REPRE);
            // console.log("cambio estados " + idestado);
        });



        ListadoClientes();
        ListadoRepresentantes();
        ListadoEstados();

    }

    function ListadoViaticos(estado, representante) {


        if (representante == 0) {
             $.ajax({
                dataType: "json",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                 url: "@Url.Action("ListadoViaticosCreados_apro", "Viaticos")",
            data: "{'estado': '" + estado + "','representante': '" + 0 + "'}",
                success: function (data) {
                console.log(data);
                    var mitablaviaticoscreados = document.getElementById("tabla_cabecera_viaticos");

                    mitablaviaticoscreados.innerHTML = ``;

                    for (cab in data) {

                        if (data[cab].est_codigo == "EA") {
                            var estado = "Eva. Aprobar"
                            mitablaviaticoscreados.innerHTML += ` <tr>
                            <td>${data[cab].id_v_num_sol}</td>
                            <td>${data[cab].NombreUsuario}</td>
                            <td>${estado}</td>
                            <td>${data[cab].Nombrelinea}</td>
                            <td>${data[cab].fecha_solicitud}</td>
                            <td>${data[cab].NombreMotivoViaje}</td>
                            <td>${data[cab].monto_solicitado}</td>

                            <td>${data[cab].NombreMedioViaje}</td>
                            <td>${data[cab].id_depart_ori}</td>
                            <td>${data[cab].id_depart_dest}</td>


                            <td><button class="btn text-white" onclick="EnviarcodigoEditViatico(${data[cab].id_v_num_sol})" data-toggle="modal" data-target="#exampleModalCenter_viatico" style="background-color:#278DE9;"><i class="bi bi-pencil-square"></i></button></td>
                            <td><button class="btn text-white" onclick="Aprobar(${data[cab].id_v_num_sol})"  style="background-color:#09B556;"><i class="bi bi-pencil-square"></i></button></td>
                            <td><button class="btn text-white" onclick="Desaprobar(${data[cab].id_v_num_sol})" style="background-color:#CE7E14;"><i class="bi bi-check2-square"></i></button></td>
                </tr>
                `;

                        }
                        else if(data[cab].est_codigo == "AP") {
                            var estado = "APROBADA"
                            mitablaviaticoscreados.innerHTML += ` <tr>
                            <td>${data[cab].id_v_num_sol}</td>
                            <td>${data[cab].NombreUsuario}</td>
                            <td>${estado}</td>
                            <td>${data[cab].Nombrelinea}</td>
                            <td>${data[cab].fecha_solicitud}</td>
                            <td>${data[cab].NombreMotivoViaje}</td>
                            <td>${data[cab].monto_solicitado}</td>

                            <td>${data[cab].NombreMedioViaje}</td>
                            <td>${data[cab].id_depart_ori}</td>
                            <td>${data[cab].id_depart_dest}</td>


                            <td><button class="btn text-white" onclick="EnviarcodigoEditViatico(${data[cab].id_v_num_sol})" data-toggle="modal" data-target="#exampleModalCenter_viatico" style="background-color:#278DE9;"><i class="bi bi-pencil-square"></i></button></td>
                            <td><button disabled class="btn text-white" onclick="Aprobar(${data[cab].id_v_num_sol})"  style="background-color:#09B556;"><i class="bi bi-pencil-square"></i></button></td>
                            <td><button disabled class="btn text-white" onclick="Desaprobar(${data[cab].id_v_num_sol})" style="background-color:#CE7E14;"><i class="bi bi-check2-square"></i></button></td>
                </tr>
                `;
                        }

                        else if (data[cab].est_codigo == "AN") {
                            var estado = "ANULADO"
                            mitablaviaticoscreados.innerHTML += ` <tr>
                            <td>${data[cab].id_v_num_sol}</td>
                            <td>${data[cab].NombreUsuario}</td>
                            <td>${estado}</td>
                            <td>${data[cab].Nombrelinea}</td>
                            <td>${data[cab].fecha_solicitud}</td>
                            <td>${data[cab].NombreMotivoViaje}</td>
                            <td>${data[cab].monto_solicitado}</td>

                            <td>${data[cab].NombreMedioViaje}</td>
                            <td>${data[cab].id_depart_ori}</td>
                            <td>${data[cab].id_depart_dest}</td>


                            <td><button class="btn text-white" onclick="EnviarcodigoEditViatico(${data[cab].id_v_num_sol})" data-toggle="modal" data-target="#exampleModalCenter_viatico" style="background-color:#278DE9;"><i class="bi bi-pencil-square"></i></button></td>
                            <td><button disabled class="btn text-white" onclick="Aprobar(${data[cab].id_v_num_sol})"  style="background-color:#09B556;"><i class="bi bi-pencil-square"></i></button></td>
                            <td><button disabled class="btn text-white" onclick="Desaprobar(${data[cab].id_v_num_sol})" style="background-color:#CE7E14;"><i class="bi bi-check2-square"></i></button></td>
                </tr>
                `;
                        }





                }

                }
                });

        }
        else {

     // var vcs_id = document.getElementById('via_num_sol').value;
        $.ajax({
                dataType: "json",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                 url: "@Url.Action("ListadoViaticosCreados_apro", "Viaticos")",
            data: "{'estado': '" + estado + "','representante': '" + representante + "'}",
                success: function (data) {
                console.log(data);
                    var mitablaviaticoscreados = document.getElementById("tabla_cabecera_viaticos");

                    mitablaviaticoscreados.innerHTML = ``;

                    for (cab in data) {

                        if (data[cab].est_codigo == "EA") {
                            var estado = "Eva. Aprobar"
                            mitablaviaticoscreados.innerHTML += ` <tr>
                            <td>${data[cab].id_v_num_sol}</td>
                            <td>${data[cab].NombreUsuario}</td>
                            <td>${estado}</td>
                            <td>${data[cab].Nombrelinea}</td>
                            <td>${data[cab].fecha_solicitud}</td>
                            <td>${data[cab].NombreMotivoViaje}</td>
                            <td>${data[cab].monto_solicitado}</td>

                            <td>${data[cab].NombreMedioViaje}</td>
                            <td>${data[cab].id_depart_ori}</td>
                            <td>${data[cab].id_depart_dest}</td>


                            <td><button class="btn text-white" onclick="EnviarcodigoEditViatico(${data[cab].id_v_num_sol})" data-toggle="modal" data-target="#exampleModalCenter_viatico" style="background-color:#278DE9;"><i class="bi bi-pencil-square"></i></button></td>
                            <td><button class="btn text-white" onclick="Aprobar(${data[cab].id_v_num_sol})"  style="background-color:#09B556;"><i class="bi bi-pencil-square"></i></button></td>
                            <td><button class="btn text-white" onclick="Desaprobar(${data[cab].id_v_num_sol})" style="background-color:#CE7E14;"><i class="bi bi-check2-square"></i></button></td>
                </tr>
                `;

                        }
                        else if(data[cab].est_codigo == "AP") {
                            var estado = "APROBADA"
                            mitablaviaticoscreados.innerHTML += ` <tr>
                            <td>${data[cab].id_v_num_sol}</td>
                            <td>${data[cab].NombreUsuario}</td>
                            <td>${estado}</td>
                            <td>${data[cab].Nombrelinea}</td>
                            <td>${data[cab].fecha_solicitud}</td>
                            <td>${data[cab].NombreMotivoViaje}</td>
                            <td>${data[cab].monto_solicitado}</td>

                            <td>${data[cab].NombreMedioViaje}</td>
                            <td>${data[cab].id_depart_ori}</td>
                            <td>${data[cab].id_depart_dest}</td>


                            <td><button class="btn text-white" onclick="EnviarcodigoEditViatico(${data[cab].id_v_num_sol})" data-toggle="modal" data-target="#exampleModalCenter_viatico" style="background-color:#278DE9;"><i class="bi bi-pencil-square"></i></button></td>
                            <td><button disabled class="btn text-white" onclick="Aprobar(${data[cab].id_v_num_sol})"  style="background-color:#09B556;"><i class="bi bi-pencil-square"></i></button></td>
                            <td><button disabled class="btn text-white" onclick="Desaprobar(${data[cab].id_v_num_sol})" style="background-color:#CE7E14;"><i class="bi bi-check2-square"></i></button></td>
                </tr>
                `;
                        }

                        else if (data[cab].est_codigo == "AN") {
                            var estado = "ANULADO"
                            mitablaviaticoscreados.innerHTML += ` <tr>
                            <td>${data[cab].id_v_num_sol}</td>
                            <td>${data[cab].NombreUsuario}</td>
                            <td>${estado}</td>
                            <td>${data[cab].Nombrelinea}</td>
                            <td>${data[cab].fecha_solicitud}</td>
                            <td>${data[cab].NombreMotivoViaje}</td>
                            <td>${data[cab].monto_solicitado}</td>

                            <td>${data[cab].NombreMedioViaje}</td>
                            <td>${data[cab].id_depart_ori}</td>
                            <td>${data[cab].id_depart_dest}</td>


                            <td><button class="btn text-white" onclick="EnviarcodigoEditViatico(${data[cab].id_v_num_sol})" data-toggle="modal" data-target="#exampleModalCenter_viatico" style="background-color:#278DE9;"><i class="bi bi-pencil-square"></i></button></td>
                            <td><button disabled class="btn text-white" onclick="Aprobar(${data[cab].id_v_num_sol})"  style="background-color:#09B556;"><i class="bi bi-pencil-square"></i></button></td>
                            <td><button disabled class="btn text-white" onclick="Desaprobar(${data[cab].id_v_num_sol})" style="background-color:#CE7E14;"><i class="bi bi-check2-square"></i></button></td>
                </tr>
                `;
                        }





                }

                }
                });

        }

        }


    function LimpiarBusqueda() {
        $('#via_repre_lst').val("0").trigger('change');

    }
 function ListadoClientes() {

      // var via_clientes_select = document.getElementById('via_clie_select');
       // if (via_clientes_select) {
            $.ajax({
                dataType: "json",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                url: "@Url.Action("ListadoClientesSoftcom", "Viaticos")",

                success: function (data) {

                var cadena = "";
                    if (data.length > 0) {

                        $.each(data, function (k, v) {
                            cadena += "<option value=''>Seleccione Cliente</option>";
                cadena += "<option value='" + v.ruc + "'>" + v.ruc + "-" + v.nombre + "</option>";
                });
                } else {
                cadena += "<option value=''>NO SE ENCONTRARON REGISTROS</option>";
                }

                $("#via_clie_select").html(cadena);
                }
                });
                //  }
                // else {



                //}

    }

  function RegistrarCliente() {
        var clienteselecionado = document.getElementById('via_clie_select');
        var codigoCliente = clienteselecionado.options[clienteselecionado.selectedIndex].value;
        var nombreCliente = clienteselecionado.options[clienteselecionado.selectedIndex].text;
        var nombreCliente_array = nombreCliente.split("-", 2);
        var nombreCliente_ok = nombreCliente_array[1];
        var vsc_id = document.getElementById('via_num_sol').value;
        var vcs_prec_proyectado = document.getElementById('via_mont_esperado_clie').value;

        //console.log("cliente ruc" + codigoCliente.trim());
        //console.log("cliente precio" + vcs_prec_proyectado);
        //console.log("cliente nom " + nombreCliente_ok.trim());
        //console.log("id solicitud" + vsc_id);

        $.ajax({
                dataType: "json",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                 url: "@Url.Action("AgregarDetalleCliente", "Viaticos")",
            data: "{'cod_cliente': '" + codigoCliente.trim() + "','nom_cliente': '" + nombreCliente_ok.trim() + "','vcs_id': '" + vsc_id + "','precio_proyectado': '" + vcs_prec_proyectado + "'}",
                success: function (data) {

                    if (data == true) {
                        swal.fire("Registro exitoso");
                        ListadoDetClie(vsc_id);
                    }
                }
            });


    }

  function Aprobar(cod_solicitud) {


        Swal.fire({
            title: '¿Esta seguro de Aprobar? SOL-00 ' + cod_solicitud,
            showDenyButton: false,
            showCancelButton: false,
            confirmButtonText: 'APROBAR',
            denyButtonText: 'DATO DE NEGAR',
             }).then((result) => {

                if (result.isConfirmed) {

                        ajax_enviaraprobarg_linea(cod_solicitud);

                } else if (result.isDenied) {
                Swal.fire('Cambios no Guardados', '', 'info')
            }
        })


    }

  function ajax_enviaraprobarg_linea(codigocotizacion) {

        console.log(codigocotizacion);
        console.log("Totalizando internamnete " + codigocotizacion);
        $.ajax({
            dataType: "json",
            type: 'POST',
            contentType: "application/json; charset=utf-8",
            data: "{ 'codigo': '" + codigocotizacion + "','estado': '" + 'AP' + "'}",

             url: "@Url.Action("AprobarViatico", "Viaticos")",
            success: function (data) {
                var respuesta = data.split('-');
                var msg = parseInt(respuesta[1]);
                var cant_clientes = parseInt(respuesta[2]);
                var presupuesto = parseInt(respuesta[3]) ;
            //    var tipo_venta = respuesta[4] ;

                console.log("POR APROBAR  ?:" + data);

                if (cant_clientes> 5 && presupuesto>0) {
                    Swal.fire('ENVIADO APROBAR SOL-00' + codigocotizacion, '', 'success');
                    ListadoViaticos("EA","0");
                }
                else if(cant_clientes <5) {
                    Swal.fire('FALLO APROBAR SOL-00' + codigocotizacion, '', 'error');
                    ListadoViaticos("EA","0");
                }



                else if (cant_clientes == 0) {
                    Swal.fire('No tiene Clientes asiganados', '', 'error');
                  //  ListarCotizacionesVendedor(3);
                }
                else if (presupuesto == 0) {
                    Swal.fire('No tiene Presupuesto asiganado', '', 'error');
                    //  ListarCotizacionesVendedor(3);
                }




                else {

                    Swal.fire('Fallo ' + msg, '', 'error');
                }



            }

        });

    }

    function Desaprobar(cod_solicitud) {
        borrarRegistroDetalle(cod_solicitud);
    }

    function borrarRegistroDetalle(codigocabecera) {
        console.log("BORRAR REGSITRO");
        var id = ingresar_motivo_anulacion(codigocabecera);

        if (id = !0) {

        }

        else {
            console.log("BORRANDO REGISTRO ARTICULO");
        }


    }

    async function ingresar_motivo_anulacion(codcot) {
        cargaMotivos(codcot);
    }

    function cargaMotivos(codcot) {

        var lista = [];
        $.ajax({
            dataType: "json",
            type: 'POST',
            contentType: "application/json; charset=utf-8",

            url: "@Url.Action("ListadoMotivos", "Viaticos")",
            data: "{}",
            success: function (data) {


                // console.log(data);
                let des = { data };
                let obj = Object.assign({}, des);
                // console.log("objeto . ." + obj[0].descripcion);
                console.log(des);



                let motivos_ = {};
                var i = 1;
                for (var a in data) {

                    motivos_[i] = data[a].descripcion;
                    i++;
                }

                    console.log("MOTIVOS . . ." + motivos_);
                    const { value: text } = Swal.fire({
                    input: 'select',
                    inputOptions:
                        motivos_
                    ,
                    inputLabel: 'Motivo',
                    inputPlaceholder: 'Escribe motivo de anulacion...',
                    inputAttributes: {
                        'aria-label': 'Type your message here'
                    },
                    showCancelButton: true,
                    inputValidator: (value) => {
                        return new Promise((resolve) => {
                            console.log("VALUEEE"+value)
                            if (value !='') {
                                //"Anulacion"
                                      $.ajax({
                                    dataType: "json",
                                    type: 'POST',
                                     contentType: "application/json; charset=utf-8",

                                    url: "@Url.Action("desaprobar_viatico", "Viaticos")",
                                    data: "{ 'codigocabecera': '" + codcot + "','id_motanul': '" + value + "'}",
                                          success: function (data) {

                                              if (data===true) {
                                                  Swal.fire('Anulado Correctamente','','success');
                                              }
                                              else {

                                              }
                                              ListadoViaticos("EA","0");
                             }
                         });

                                resolve();

                            } else {
                                resolve('Necesita selecionar un motivo :)'+value)
                            }
                        })
                    }
                })

                if (text) {
                    Swal.fire(`You selected: ${text}`)
                }



            }
        });

        return lista;
    }

    function SumaPresupuestoPorSolicitud(id_solicitud) {

        var sumaAcumulada = 0;
        console.log("id solicitud "+id_solicitud);

      // suma = 5000 + 200;

        sumaAcumulada=   $.ajax({
                async:'false',
                dataType: "json",
                type: 'POST',
                global: 'false',
                contentType: "application/json; charset=utf-8",
                 url: "@Url.Action("MontoPresupuestadoporSolicitud", "Viaticos")",
                data: "{'id_solicitud': '" + id_solicitud + "'}",
                success: function (data) {                  //console.log(data);
                    if (data.Nombrelinea=="") {
                        //sumaAcumulada = 0;
                    }
                    else {
                        var x = parseFloat(data.Nombrelinea);
                        //console.log("X" + x);
                     sumaAcumulada = x;

                    }
            }

        });
        console.log(sumaAcumulada);
        return sumaAcumulada;
    }

     function EnviarcodigoEditViatico(codigocabecera) {
         ListadoDetClie(codigocabecera);
         ListadoDetallePresupuesto(codigocabecera);
        // listarDetalleCotizacion(codigocabecera);
        //  listarDetalleCotizacion(codigocabecera);

             $.ajax({
            dataType: "json",
            type: 'POST',
            contentType: "application/json; charset=utf-8",
            data: "{ 'codigo': '" + codigocabecera + "'}",
              url: "@Url.Action("ObtenerSolictudViatico", "Viaticos")",
            //url: '/Cotizador/traer_dato_para_codigo',
            success: function (data) {

               // console.log(data.cliente);
                document.getElementById("via_num_sol").value = codigocabecera;
                document.getElementById("v_r_nombre").value = data.NombreUsuario;


               // ListaArticulosporAlmacen(codAlmacen);

             }
        });
        }

    function ListadoDetClie(vcs_id) {
        // var vcs_id = document.getElementById('via_num_sol').value;

        $.ajax({
                dataType: "json",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                 url: "@Url.Action("ListadoDetClie", "Viaticos")",
            data: "{'vcs_id': '" + vcs_id + "'}",
                success: function (data) {
                    console.log(data);
                    var mitabladetcliente = document.getElementById("via_detalle_clientes");

                    mitabladetcliente.innerHTML = ``;

                    for (cab in data) {

                        mitabladetcliente.innerHTML += ` <tr>

                                    <td>${data[cab].cod_clie}</td>
                                  <td>${data[cab].nom_clie}</td>
                                   <td>S/${FormatoMoneda(data[cab].precio_proyectado)}</td>
                                  <td><button class="btn text-white" onclick="AnularCliente(${data[cab].cod_clie},${data[cab].vcs_id})" style="background-color:#D22B08;"><i class="bi bi-clipboard2-x"></i></button></td>



                                </tr>
                                    `;



                    }

                }
            });
    }

    const FormatoMoneda = (number) => {
        const exp = /(\d)(?=(\d{3})+(?!\d))/g;
        const rep = '$1,';
        let arr = number.toString().split('.');
        arr[0] = arr[0].replace(exp, rep);
        return arr[1] ? arr.join('.') : arr[0];
    }

    function ListadoDetallePresupuesto(id_solicitud) {

        $.ajax({
                dataType: "json",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                 url: "@Url.Action("ListadoDet_Presupuesto", "Viaticos")",
            data: "{'id_solicitud': '" + id_solicitud + "'}",
                success: function (data) {
                    console.log(data);
                    var mitabladetpresupuesto= document.getElementById("via_dt_concepto_presupuesto");
                    mitabladetpresupuesto.innerHTML = ``;

                    for (cab in data) {
                        var precio_maximo = data[cab].precio_maximo;
                        var descripcion_gasto = data[cab].descripcion_gasto;
                      //  document.getElementById('precio_maximo_gasto').value = precio_maximo;
                        var cantidad = "cant" + data[cab].id_gasto;
                        var precio = "prec" + data[cab].id_gasto;

                        if (data[cab].dias > 0 && data[cab].precio > 0 ) {

                            mitabladetpresupuesto.innerHTML += ` <tr>
                   
                        <td><input type="image" src="${data[cab].icon}" title="${descripcion_gasto}" width="20" height="20"/></td>
                         <td>${data[cab].nombregasto}</td>
                         <td>${data[cab].dias}</td>
                          <td>${data[cab].precio}</td>

                          <td><button class="btn text-white" onclick="RegistrarDetallePresupuesto(${data[cab].id_gasto},${cantidad},${precio},${precio_maximo})"  style="background-color:#09B556;"><i class="bi bi-pencil-square"></i></button></td>
                          <td><button class="btn text-white borrar" onclick="AnularDetPresupuesto(${data[cab].id_gasto})" style="background-color:#D22B08;"><i class="bi bi-clipboard2-x"></i></button></td>
                        <td><button class="btn text-white borrar" onclick="Editar_Presupuesto(${data[cab].id_v_num_sol},${data[cab].id_gasto},${data[cab].dias},${data[cab].precio})" data-toggle="modal" data-target="#exampleModalCenter_VIA_GASTO"  style="background-color:#D22B08;"><i class="bi bi-clipboard2-x"></i></button></td>
                          </tr>
                           `;

                        }
                        else {

                            var precio_maximo = data[cab].precio_maximo;
                            var descripcion_gasto = data[cab].descripcion_gasto;
                           // document.getElementById('precio_maximo_gasto').value = precio_maximo;
                            mitabladetpresupuesto.innerHTML += ` <tr>
                         
                          <td><input type="image" src="${data[cab].icon}" title="${descripcion_gasto}" width="20" height="20"/></td>
                         <td> ${data[cab].nombregasto}</td>

                          <td> <input type='text' id='${cantidad}' alt='${descripcion_gasto}' </td>
                          <td> <input type='text' id='${precio}'</td>
                          <td><button class="btn text-white" onclick="RegistrarDetallePresupuesto(${data[cab].id_gasto},${cantidad},${precio},${precio_maximo})"  style="background-color:#09B556;"><i class="bi bi-pencil-square"></i></button></td>
                          <td><button class="btn text-white borrar" onclick="AnularDetPresupuesto(${data[cab].id_gasto})" style="background-color:#D22B08;"><i class="bi bi-clipboard2-x"></i></button></td>
                          </tr>
                           `;
                        }





                    }

                }
            });

    }

    function RegistrarDetallePresupuesto(id_gasto, cantidad, precio, precio_maximo) {

        console.log(precio_maximo);

        var id_solicitud = document.getElementById('via_num_sol').value;

        if (cantidad.vale != "" && precio.value != "" && id_solicitud != "" && precio.value<=precio_maximo) {




                $.ajax({
                    dataType: "json",
                    type: 'POST',
                    contentType: "application/json; charset=utf-8",

                    url: "@Url.Action("RegistroDetallePresupuesto", "Viaticos")",
                    data: "{'id_solicitud': '" + id_solicitud + "','id_gasto': '" + id_gasto + "','cantidad': '" + cantidad.value + "','precio': '" + precio.value + "'}",

                    success: function (data) {

                        if (data == true) {
                            Swal.fire("Datos Registrados", "", "success");
                            document.getElementById('cantidad');

                            $(cantidad).prop("disabled", true);
                            $(precio).prop("disabled", true);

                        }
                        else {
                            Swal.fire("Este Gasto ya fue Registrado anteriormente", "", "error");

                        }

                    }
                });
            }

        else {


            if (precio.value >= precio_maximo) {

                Swal.fire("Precio mayor al maximo S/ " + precio_maximo , '', "warning");

            }

            else {
                Swal.fire("Datos Incompletos" ,'', "info");
            }


        }
    }



    function ListadoRepresentantes() {

      // var via_clientes_select = document.getElementById('via_clie_select');
       // if (via_clientes_select) {
         var app_function = 2; ////APROBACION
            $.ajax({
                dataType: "json",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                url: "@Url.Action("ListaUsuarios", "Viaticos")",
               // data: "{'app_function': '" + app_function + "'}",
                success: function (data) {
                    console.log(data);
                var cadena = "";
                    if (data.length > 0) {
                        cadena += "<option value='0'>Seleccione Representante</option>";
                        $.each(data, function (k, v) {

                            cadena += "<option value='" + v.codigo + "'>" + v.nombre + "</option>";
                             });
                            }
                        else {
                                  cadena += "<option value=''>NO SE ENCONTRARON REGISTROS</option>";
                             }

                             $("#via_repre_lst").html(cadena);
                            }
                            });
                //  }
                // else {



                //}

    }

     function ListadoEstados() {

      // var via_clientes_select = document.getElementById('via_clie_select');
       // if (via_clientes_select) {
         var app_function = 2; ////APROBACION
            $.ajax({
                dataType: "json",
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                url: "@Url.Action("ListadoEstados", "Viaticos")",
                data: "{'app_function': '" + app_function + "'}",
                success: function (data) {
                    console.log(data);
                var cadena = "";
                    if (data.length > 0) {
                        cadena += "<option disabled value=''>Seleccione Estado</option>";
                        $.each(data, function (k, v) {

                            cadena += "<option selected value='" + v.est_codigo + "'>" + v.est_codigo + "-" + v.est_descri + "</option>";
                             });
                            }
                        else {
                                  cadena += "<option value=''>NO SE ENCONTRARON REGISTROS</option>";
                             }

                            $("#est_via_apro").html(cadena);
                            }
                            });
                //  }
                // else {



                //}

    }


    function capturadatos() {
        //document.getElementById("dias_gasto_modificar").value ;
        //document.getElementById("precio_gasto_modificar").value;

        var x = $("#dias_gasto_modificar").val();

        document.getElementById("dias_gasto_modificar").value =x;
      // var y = $("#precio_gasto_modificar").val();

        //console.log(x+" "+y);
        return x;
    }

    function capturadatos_2() {
        //document.getElementById("dias_gasto_modificar").value;
        //document.getElementById("precio_gasto_modificar").value;

     //   var x = $("#dias_gasto_modificar").val();
        var y = $("#precio_gasto_modificar").val();
        //y = 90;



        document.getElementById("precio_gasto_modificar").value = y;

       // console.log(x + " " + y);
        return y;
    }
    function Editar_Presupuesto(cod_solicitud, cod_gasto,dias,precio) {


        document.getElementById("dias_gasto_modificar").value = dias;
        document.getElementById("precio_gasto_modificar").value = precio;

        //var x = capturadatos();
        //var y = capturadatos_2();
      //  console.log(x+ "- - -" + y);
        //var dia_up= document.getElementById("dias_gasto_modificar").value;
        //var precio_up =document.getElementById("precio_gasto_modificar").value ;


        //via-gastos-mod-btn
        $("#via-gastos-mod-btn").click(function () {

            //var x = capturadatos();
            //var y = capturadatos_2();
            //console.log(x + "- - -" + y);

           var x= document.getElementById("dias_gasto_modificar").value ;
           var y=  document.getElementById("precio_gasto_modificar").value ;
             $.ajax({
                    dataType: "json",
                    type: 'POST',
                    contentType: "application/json; charset=utf-8",

                    url: "@Url.Action("EditarDetallePresupuesto", "Viaticos")",
                 data: "{'id_solicitud': '" + cod_solicitud + "','id_gasto': '" + cod_gasto + "','cantidad': '" + x + "','precio': '" + y + "'}",

                    success: function (data) {

                        if (data == true) {
                            Swal.fire("Datos Actualizador", "", "success");

                            $("#exampleModalCenter_VIA_GASTO input").val("");
                            ListadoDetallePresupuesto(cod_solicitud);
                            //document.getElementById('cantidad');

                            //$(cantidad).prop("disabled", true);
                            //$(precio).prop("disabled", true);
                            X = "";
                            Y = "";
                            ListadoViaticos("EA","0");
                            $("#exampleModalCenter_VIA_GASTO").modal("hide");
                            cod_solicitud = 0;
                            cod_gasto = 0;

                        }
                        else {
                            //SE EJECUTA EL NUMERO DE LA LISTA ERROR NO DETECTADO  POR ESO QUITE EL FIRE
                            //Swal.fire("Error al actualizar Gasto", "", "error");

                        }

                    }
                });

        });



    }





</script>

